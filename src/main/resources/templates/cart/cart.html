<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>Fruitables - Vegetable Website Template</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link th:href="@{/lib/lightbox/css/lightbox.min.css}" rel="stylesheet">
    <link th:href="@{/lib/owlcarousel/assets/owl.carousel.min.css}" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link th:href="@{/css/style_test.css}" rel="stylesheet">

    <style>
        .footer1 {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #f8f9fa;
            padding: 10px 0;
            border-top: 1px solid #dee2e6;
        }
        .custom-btn {
            height: 30px;
            width: 30px;
            font-size: 16px;
            display: flex;
            border: none;
        }
        .table th, .table td {
            vertical-align: middle;
        }
        .formatted-price {
            color: #007bff;
        }
    </style>
</head>
<body>

<div th:replace="header :: header"></div>

<!-- Page Header -->
<div class="container-fluid page-header py-5">
    <h1 class="text-center text-white display-6">Giỏ hàng</h1>
    <ol class="breadcrumb justify-content-center mb-0">
        <li class="breadcrumb-item"><a href="/homepage">Trang chủ</a></li>
        <li class="breadcrumb-item active text-white">Giỏ hàng</li>
    </ol>
</div>

<!-- Main Content -->
<div class="container mt-5">
    <div th:each="canteenEntry : ${cartItemsGroupedByCanteen}">
        <div class="card mt-4">
            <div class="card-header" style="background-color: #fff3cd">
                <label>
                    <input type="checkbox" th:id="${'canteen' + canteenEntry.key.canteenId}" class="shop-checkbox" />
                </label>
                <label th:for="${'canteen' + canteenEntry.key.canteenId}" th:text="${canteenEntry.key.canteenName}">Canteen Name</label>
            </div>
            <div class="card-body">
                <table class="table">
                    <thead>
                    <tr style="align-items: center;justify-content: center">
                        <th>Sản phẩm</th>
                        <th>Giá</th>
                        <th>Số lượng đang có</th>
                        <th>Số lượng mua</th>
                        <th>Tổng</th>
                        <th>Thao tác</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="item : ${canteenEntry.value}">
                        <td>
                            <label>
                                <input type="checkbox" th:id="${'product' + item.cartItemId}" class="product-checkbox" th:data-canteen="${'canteen' + canteenEntry.key.canteenId}"/>
                            </label>
                            <label th:for="${'product' + item.cartItemId}" th:text="${item.food.foodName}" style="width: 100px">Product Name</label>
                        </td>
                        <td class="formatted-price" th:text="${item.food.price}"></td>
                        <td  th:text="${item.food.foodQuantity}"></td>
                        <td style="display: flex;height: 78.4px;align-items: center;justify-content: center">
                            <button class="custom-btn btn-minus btn-info" th:attr="data-id=${item.cartItemId}">-</button>
                            <label>
                                <input type="number" min="1" th:id="'qty' + ${item.cartItemId}" th:value="${item.quantity}" class="form-control qty-input" style="width: 60px; display: inline-block;">
                            </label>
                            <button class="custom-btn btn-plus btn-info" th:attr="data-id=${item.cartItemId}">+</button>
                        </td>
                        <td class="formatted-price" th:id="'total' + ${item.cartItemId}" th:text="${item.food.price * item.quantity} ">Total</td>
                        <td>
                            <form th:action=" @{/remove_cartItem}" method="post" style="display:inline;">
                                <input type="hidden" name="cartItemId" th:value="${item.cartItemId}"/>
                                <button type="submit" class="btn btn-md rounded-circle bg-light border mt-4">
                                    <i class="fa fa-times text-danger"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Footer with Checkout Button -->
<div class="footer1 text-center">
    <span>Total Quantity: <span id="totalQuantity">0</span></span> |
    <span>Total Price: <span class="formatted-price" id="totalPrice">0</span></span>
    <button id="checkoutButton" class="btn btn-success">Proceed to Checkout</button>
</div>

<!-- Modal for Multi-Canteen Checkout -->
<div class="modal fade" id="checkoutModal" tabindex="-1" role="dialog" aria-labelledby="checkoutModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="checkoutModalLabel">Checkout Alert</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                You cannot check out items from multiple canteens at once. Please select items from one canteen only.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Form for Checkout Submission -->
<form id="checkoutForm" action="/checkout" method="get" style="display: none;">
    <input type="hidden" name="cartItemIds" id="cartItemIds">
</form>

<!-- Footer Replacement -->
<div th:replace="footer :: footer"></div>

<!-- Back to Top Button -->
<a href="#" class="btn btn-primary border-3 border-primary rounded-circle back-to-top"><i class="fa fa-arrow-up"></i></a>

<!-- JavaScript Libraries -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/lib/easing/easing.min.js}"></script>
<script th:src="@{/lib/waypoints/waypoints.min.js}"></script>
<script th:src="@{/lib/lightbox/js/lightbox.min.js}"></script>
<script th:src="@{/lib/owlcarousel/owl.carousel.min.js}"></script>

<!-- Template JavaScript -->
<script th:src="@{/js/main_test.js}"></script>

<script>
    $(document).ready(function() {
        function formatCurrencyVND(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        function updateTotal() {
            let totalQuantity = 0;
            let totalPrice = 0;
            $('.product-checkbox:checked').each(function() {
                const cartItemId = $(this).attr('id').replace('product', '');
                const quantity = parseInt($('#qty' + cartItemId).val());
                const price = parseFloat($($(this).closest('tr').find('td')[1]).text());
                totalQuantity += quantity;
                totalPrice += price * quantity;
            });
            $('#totalQuantity').text(totalQuantity);
            $('#totalPrice').text(formatCurrencyVND(totalPrice)); // Ensure VND formatting on update
        }

        $('.btn-minus, .btn-plus').on('click', function() {
            const button = $(this);
            const cartItemId = button.data('id');
            const input = $('#qty' + cartItemId);
            const oldValue = parseInt(input.val());
            let newQuantity = (button.hasClass('btn-minus')) ? Math.max(oldValue - 1, 1) : oldValue + 1;
            input.val(newQuantity).change();
        });

        $('.qty-input').on('change', function() {
            const cartItemId = $(this).attr('id').replace('qty', '');
            const quantity = parseInt($(this).val());
            const price = parseFloat($($(this).closest('tr').find('td')[1]).text());
            const total = quantity * price;
            $('#total' + cartItemId).text(formatCurrencyVND(total)); // Ensure VND formatting on quantity change
            updateTotal();
        });

        $('.shop-checkbox').change(function() {
            const isChecked = $(this).is(':checked');
            const canteenId = $(this).attr('id');
            $('input[data-canteen="' + canteenId + '"]').prop('checked', isChecked).change();
            updateTotal();
        });

        $('.product-checkbox').change(function() {
            const canteenId = $(this).data('canteen');
            const allChecked = $('input[data-canteen="' + canteenId + '"]:not(:checked)').length === 0;
            $('#' + canteenId).prop('checked', allChecked);
            updateTotal();
        });

        $('#checkoutButton').click(function() {
            var selectedCanteens = new Set();
            var cartItemIds = [];
            $('.product-checkbox:checked').each(function() {
                selectedCanteens.add($(this).data('canteen'));
                cartItemIds.push($(this).attr('id').replace('product', ''));
            });

            if (selectedCanteens.size > 1) {
                // Show modal warning if more than one canteen's items are selected
                $('#checkoutModal').modal('show');
            } else {
                // Proceed to checkout page
                $('#cartItemIds').val(cartItemIds.join(','));
                $('#checkoutForm').submit();
            }
        });

        // Format all initial and dynamically updated prices on page load
        document.querySelectorAll('.formatted-price').forEach(function (element) {
            let price = parseFloat(element.innerText.replace(/[^\d.]/g, '')); // Remove non-numeric characters
            element.innerText = formatCurrencyVND(price);
        });
    });
</script>

</body>
</html>
